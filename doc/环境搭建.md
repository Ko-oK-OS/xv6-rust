# 环境搭建

## 1、ubuntu20.04 及相关环境

```bash
sudo apt-get update && sudo apt-get upgrade
sudo apt-get install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu
sudo apt-get install riscv64-unknown-elf-gcc 
#不能定位的话尝试 gcc-riscv64-unknown-elf
```

还有些杂七杂八的比如说 vim，vmtools 工具之类的

## 2、qemu

```bash
wget https://download.qemu.org/qemu-5.0.0.tar.xz  
tar xvJf qemu-5.0.0.tar.xz  
cd qemu-5.0.0  
./configure --target-list=riscv32-softmmu,riscv64-softmmu   
make -j$(nproc)  
sudo make install  
```

If you find some errors when building, you can slove by following hints:

- `ERROR: pkg-config binary 'pkg-config' not found` : `sudo apt-get install pkg-config`
- `ERROR: glib-2.48 gthread-2.0 is required to compile QEMU`: `sudo apt-get install libglib2.0-dev`
- `ERROR: pixman >= 0.21.8 not present`: `sudo apt-get install libpixman-1-dev`

## 3、clone

```bash
git clone https://github.com/Ko-oK-OS/xv6-rust.git
```

其中有三个子仓库 clone 不下来，自己克隆或者下载然后移动进去，因为权限的原因没法直接使用 

```bash
git submodule update --init --recursive
```

或者是去修改 .gitmodule 文件 URL 前缀为 https (不过直接修改不行，可以尝试删除然后自己再添加，难得折腾了)

![image-20220502221208991](C:/Users/Rand/AppData/Roaming/Typora/typora-user-images/image-20220502221208991.png)

## 4、RUST相关环境

You need download rust to start our environment. We suggest you to use official shell:

```bash
curl https://sh.rustup.rs -sSf | sh
```

If you fail because of slow network speed. You can try this to speed up:

```bash
export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static
export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup
curl https://sh.rustup.rs -sSf | sh
```

If you have finished these, you can test your environment by following commands:

```bash
source $HOME/.cargo/env  
rustc --version
```

In addition, we'd better change the package mirror address crates.io used by the package manager cargo to the mirror server of the University of Science and Technology of China to speed up the download of the tripartite library. We open (create a new file if it doesn't exist) ~/.cargo/config and modify the content to:

```
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'ustc'
[source.ustc]
registry = "git://mirrors.ustc.edu.cn/crates.io-index"
```

Besides, you also update some tools in rust:

```bash
rustup target add riscv64gc-unknown-none-elf
cargo install cargo-binutils
rustup component add llvm-tools-preview
```

!!!!!!!!!!! 最后这一步的这两个命令

```bash
rustup target add riscv64gc-unknown-none-elf
rustup component add llvm-tools-preview
```

需要在 xv6-rust 目录下执行一次，还需要在 xv6-rust/kernel 目录下执行一次

## 5、搭建完成

```
make run
```

